{% extends "page_base.jinja2" %}
{% block scripts %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
<script src="{{request.static_url('totter:static/js/jquery.autoresize.js')}}"></script>
<script type="text/javascript">
    (function($) {
        $(document).ready(function(){
            // Expanding textarea
            $message_area = $(".email_invite textarea");
            $message_area.autoResize({max_width : 'original', min_height:'original', extraSpace: 10});
        
            // Expanding fieldset
            $email_fieldset = $(".email_invite fieldset");
            $rem_emails_btn = $(".email_invite #remove_emails");
            i = 0; // Next free email row.
            email_row = function() {return $('<div id="email"><label>Email address:</label><input name="email_'+(i++)+'" type="text"/></div>');}
            $email_fieldset.empty();
            $last_added = email_row();
            $email_fieldset.append($last_added);
            function add_row(event) {
                console.log("focused");
                $new = email_row();
                $last_added.find('input').unbind('focus');
                $email_fieldset.append($new);
                $last_added = $new;
                $last_added.find('input').focus(add_row);
                $rem_emails_btn.removeClass('hidden');
            }
            $last_added.find('input').focus(add_row);
            $rem_emails_btn.click(function(event) {
                event.preventDefault();
                if (i > 1) {
                    $last_added.remove();
                    $last_added = $email_fieldset.find("div:last-child");
                    $rem_emails_btn.removeClass('hidden');
                    --i;
                    $last_added.find('input').focus(add_row);
                    if (i <= 1) {
                        $rem_emails_btn.addClass('hidden');
                    }
                }
            });
            
            // Simple email validation:
            $submit_btn = $(".email_invite #invite");
            $invalid_msg = $(".email_invite #invalid_msg");
            $form = $(".email_invite form");
            function on_submit(event) {
                // Reset the UI that indicates bad things:
                $email_fieldset.children().each(function(index, value) {
                    $invalid_msg.addClass('hidden');
                    $label = $(value).find('label');
                    $input = $(value).find('input');
                    $label.removeClass('bad');
                    $input.removeClass('bad');
                });
                // Validate:
                $email_fieldset.children().each(function(index, value) {
                    $value = $(value);
                    $input = $value.find('input');
                    field_value = $input.val().trim();
                    $input.val(field_value);
                    $label = $value.find('label');
                    if (field_value.length == 0)
                        return; // Ignore.
                    at_index = field_value.indexOf('@');
                    if (at_index == -1 || at_index==0 || at_index==field_value.length-1) {
                        $label.addClass('bad');
                        $input.addClass('bad');
                        $invalid_msg.removeClass('hidden');
                        event.preventDefault();
                    }
                });
                
                $
            }
            $submit_btn.click(on_submit);
            $form.submit(on_submit);
            
		});
		
    })(jQuery);
</script>
{% endblock %}
{% block page_body %}
    <div class="email_invite">
    {% if created %}<h1>Project created successfully!</h1>{% endif %}
    {% if invited %}<h1>Successfully sent {{invitee_count}} invites.</h1>{% endif %}
    <h2><a href="{{project.url}}">Go to the project now!</a></h2>
    
    <div class="invite_method">
    <h3>Share this information to invite people:</h3>
    Project URL: {{project.url}} <br/>
    Project Access Key: {{project.key}}
    </div> <!-- .invite_method -->
    
    <div class="invite_method">
        <h3>Invite via email:</h3>
        <form method="post" action="{{request.current_route_url()}}">
            <div id="invalid_msg" class="hidden bad">These emails don't look valid. Please check them again.</div>
            <div>
            <fieldset>
                <div id="email"><label>Email address:</label><input name="email_0" type="text"/></div>
                <div id="email"><label>Email address:</label><input name="email_1" type="text"/></div>
                <div id="email"><label>Email address:</label><input name="email_2" type="text"/></div>
                <div id="email"><label>Email address:</label><input name="email_3" type="text"/></div>
            </fieldset>
            <button id="remove_emails" class="hidden">Remove</button>
            </div>
            <div id="subject"><label>Subject:</label><input name="subject" type="text" value="I've invited you to a totter project!"/></div>
<!-- textarea, why do you care about spaces? -->
<textarea name="message">
Hi, {{creator.first_name}} has invited you to participate in a totter project entitled "{{project.title}}"!

You can access the project at: &lt;{{project.url}}&gt;.
Please use the secret project key: {{project.key}}.

What is a totter project? It's a fun and easy way to share ideas with people on just about anything!
</textarea>
            <button id="invite">Invite</button>
        </form>
    </div> <!-- .invite_method -->
    
    </div> <!-- .email_invite -->
    
    <!--
    <div id="fb-root"></div>
    <script src="http://connect.facebook.net/en_US/all.js"></script>
    <p>
      <input type="button"
        onclick="sendRequestToRecipients(); return false;"
        value="Send Request to Users Directly"
      />
      <input type="text" value="User ID" name="user_ids" />
      </p>
    <p>
    <input type="button"
      onclick="sendRequestViaMultiFriendSelector(); return false;"
      value="Send Request to Many Users with MFS"
    />
    </p>
    
    <script>
      FB.init({
        appId  : '{{fb_app_id}}',
        status : true,
        cookie : true,
        oauth: true
      });

      function sendRequestToRecipients() {
        var user_ids = document.getElementsByName("user_ids")[0].value;
        FB.ui({method: 'apprequests',
          message: 'My Great Request',
          to: user_ids, 
          display: 'iframe',
          access_token: ''
        }, requestCallback);
      }

      function sendRequestViaMultiFriendSelector() {
        FB.ui({method: 'apprequests',
          message: 'My Great Request',
          display: 'popup',
          access_token: '{{fb_access_token}}'
        }, requestCallback);
      }
      
      function requestCallback(response) {
        // Handle callback here
        console.log(response);
        return true;
      }
    </script>
    -->
{% endblock %}