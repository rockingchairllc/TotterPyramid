{% extends "project_base.jinja2" %}
{% set active_page = "ideas" %}

{% block scripts %}
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
	<script type="text/javascript">
		function showComment(idx) {
			$('#comments'+idx).children('.new_comment').toggle();
		}
		
		function submitkey_binding(e) {
			if( e.keyCode==13 ){
                idx = $(this).attr("order");
                var prjId = "{{project.id}}";
                var cmtdata = $(this).val();
				var CommentData = JSON.stringify({'data': cmtdata, 'project_id': prjId, 'Idea_id': idx });
				$.ajax({
					url:"{{request.application_url}}/project/{{project.id}}/idea/" + idx + "/comment",
					type: "POST",
					dataType: "json",
					data: CommentData,
					success: function(){
						var m_data = '<li class="first_update"> <a href="#"> <img src="{{user.profile_picture}}?type=square" width="32" height="32" /> </a>' +
										'<div class="comment_body"> <a href="#">{{user.first_name}} </a>' + cmtdata + '</div></li>';
						$('#comments'+idx).children('.new_comment').after(m_data);
						showComment(idx);	
						$('#comments'+idx).children('.new_comment').children('.comment_text').val('');
					}
				});
            }
		}
		$(document).ready(function(){
			$('.comment_text').bind('keypress', submitkey_binding);
		});
		function addIdea() {
			$('.add_idea').toggle();
		}
		function addRating(idea_id, value, type) {
			var ratingData;
			var likeobj = "#likeidea" + idea_id;
			var loveobj = "#loveidea" + idea_id;
			if (type == 1) {
				var sw_value = $(likeobj).attr("order");
				if (sw_value == "1") //now it's displayed text is "Like it"
				{ 
					$(likeobj).attr("order", "2");
					$(likeobj).text("Unlike it");
					$(loveobj).attr("order", "1");
					$(loveobj).text("Love it");
					value = value + 1
					ratingData = JSON.stringify({'like': 1, 'love': 0});
				}
				else if (sw_value == "2" ) //now it's displayed text is "Unlike it"
				{
					$(likeobj).attr("order", "1");
					$(likeobj).text("Like it");
					$(loveobj).attr("order", "1");
					$(loveobj).text("Love it");
					value = value - 1
					ratingData = JSON.stringify({'like': 0, 'love': 0});
				}
			}
			else if (type == 2){
				var sw_value = $(loveobj).attr("order");
				if (sw_value == "1") //now it's displayed text is "Love it"
				{ 
					$(loveobj).attr("order", "2");
					$(loveobj).text("Unlove it");
					$(likeobj).attr("order", "1");
					$(likeobj).text("Like it");
					value = value + 2
					ratingData = JSON.stringify({'like': 0, 'love': 1});
				}
				else if (sw_value == "2" ) //now it's displayed text is "Unlove it"
				{
					$(loveobj).attr("order", "1");
					$(loveobj).text("Love it");
					$(likeobj).attr("order", "1");
					$(likeobj).text("Like it");
					value = value - 2
					ratingData = JSON.stringify({'like': 0, 'love': 0});
				}
			}
			
			outText = 'Total Rating: ' + value;
			idText = "rate_value" + idea_id;
			$('#'+idText).html(outText);
			$.ajax({
				url:"{{request.application_url}}/project/{{project.id}}/idea/" + idea_id + "/rating",
				type: "POST",
				dataType: "json",
				data: ratingData,
				success: function(){
					//alert("ajax success");
				}
			});
		}
		
		function addIdea_to_project() {
			var prjId = "{{project.id}}";
			var IdeaData = JSON.stringify({'data': $(".add_idea_modal textarea").val(), 'project_id': prjId });
			$.ajax({
				url:"{{request.application_url}}/project/{{project.id}}/idea",
				type: "POST",
				dataType: "json",
				data: IdeaData,
				success: onSuccess_addIdea
			});
			
			function onSuccess_addIdea(data){
				var new_id = data.idea_id;
				var prepare_data = '<li><div class="idea_author"><a href="#"><img src={{user.profile_picture}}?type=square"/></a></div>' +
                    '<div class="idea_body"><div class="idea_meta"><div class="username"><a href="#">{{user.first_name}}</a></div>' +
	                '<strong id="rate_value'+new_id+'">Total Rating: 0</strong><div class="like_love">' +
	                '<a href="#" id="likeidea'+new_id+'" order="1" onClick="addRating(' + new_id + ', 0, 1)">Like It</a> &bull; <a href="#" id="loveidea'+new_id+'" order="1" onClick="addRating(' + new_id + ', 0, 2)">Love It</a>' + 
	                '</div><!-- like_love --></div><!-- .idea_meta --><div class="idea_description">'+ $(".add_idea_modal textarea").val() +'</div><div class="comment_time">' +
                    '<a href="javascript:void(0)" class="comment_on_idea" onClick="showComment('+new_id+')">Comment</a>&#124;September 18th at 9:30am</div><!-- .comment_time -->' +
                    '<ul class="project_idea_comments" id="comments'+new_id+'"><li class="new_comment first_update"><input class="comment_text" type="text" value="Start Typing" order="'+new_id+'"/><br /><span class="enter_to_submit">Push Enter to Submit</span>' +
                    '</li><!-- .new_comment --><!-- Append all new comments to the ul.project_idea_comments --></ul><!-- .project_idea_comments --></div><!-- idea_body --></li>';
                $('.project_ideas').prepend(prepare_data);
                $('#comments'+new_id).children('.new_comment').children('.comment_text').bind('keypress', submitkey_binding);
			}
			addIdea();
		}
		
		function SortBy(sort_type){
			if (sort_type == 1) { //sort by date
				//alert("{{request.application_url}}/project/{{project.id}}/ideas?" + 'sort="date"');
				window.location = "{{request.current_route_url()}}?" + 'sort=date';
			}
			else if (sort_type == 2) { //sort by Rating
				window.location = "{{request.current_route_url()}}?" + 'sort=rating';
			}
			else if (sort_type == 3) { //sort by User
				window.location = "{{request.current_route_url()}}?" + 'sort=user';
			}
		} 
	</script>
{% endblock %}

{% block project_body %}
            <div class="sort_by">
                Sort by:<br />
                <button type="button" onClick="SortBy(1)">Date</button>
                <button type="button" onClick="SortBy(2)">Rating</button>
                <button type="button" onClick="SortBy(3)">User</button>
            </div><!-- .sort_by -->
            
            <ul class="project_ideas">
            {% for ideas_index in range(ideas_count) %}
            	<li>
                	<div class="idea_author">
                    	<a href="#">
                            <img src={{idea_data[ideas_index].idea.author.profile_picture}}?type=square" />
                        </a>
                    </div><!-- .idea_author -->
                    <div class="idea_body">
                        <div class="idea_meta">
                        <div class="username"><a href="#">{{idea_data[ideas_index].idea.author.first_name}}</a></div>
	                    	<strong id="rate_value{{idea_data[ideas_index].idea.id}}" >Total Rating: {{idea_data[ideas_index].total_rating}}</strong>
	                        <div class="like_love">
	                        {% if idea_data[ideas_index].user_rating.liked == 1 %}
	                        	<a href="#" id="likeidea{{idea_data[ideas_index].idea.id}}" order="2" onClick="addRating({{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 1)">Unlike It</a>
	                        {% else %}
	                        	<a href="#" id="likeidea{{idea_data[ideas_index].idea.id}}" order="1" onClick="addRating({{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 1)">Like It</a>
	               			{% endif %}         	 
	                            &bull; 
	                        {% if idea_data[ideas_index].user_rating.loved == 1 %}
	                            <a href="#" id="loveidea{{idea_data[ideas_index].idea.id}}" order="2" onClick="addRating({{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 2)">Unlove It</a>
	                        {% else %}
	                        	<a href="#" id="loveidea{{idea_data[ideas_index].idea.id}}" order="1" onClick="addRating({{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 2)">Love It</a>
	                       	{% endif %} 
	                        </div><!-- like_love -->
                        </div><!-- .idea_meta -->
                    	<div class="idea_description">{{idea_data[ideas_index].idea.data}}</div>
                        <div class="comment_time">
                            <a href="javascript:void(0)" class="comment_on_idea" onClick="showComment({{idea_data[ideas_index].idea.id}})">Comment</a> 
                            &#124; 
                            {{idea_data[ideas_index].idea.creation_time | timefmt}}
                        </div><!-- .comment_time -->
                         
                        <ul class="project_idea_comments" id="comments{{idea_data[ideas_index].idea.id}}">
                            <li class="new_comment first_update">
                            	<input class="comment_text" type="text" value="Start Typing" order = "{{idea_data[ideas_index].idea.id}}"/><br />
                                <span class="enter_to_submit">Push Enter to Submit</span>
                            </li><!-- .new_comment -->
                             
                            <!-- Append all new comments to the ul.project_idea_comments -->
                            
                            {% for comment in idea_data[ideas_index].idea.comments %}
	                            {% if loop.first %} 
	                            	<li class="first_update">
	                            {% elif loop.last %}
	                            	<li class="last_update">
	                            {% else %}
	                            	<li>
	                            {% endif %}	
	                            	<a href="#">
	                                	<img src="{{comment.author.profile_picture}}?type=square" width="32" height="32" />
	                                </a>
	                                <div class="comment_body">
	                                    <a href="#">{{comment.author.first_name}}</a>
	                                    {{comment.data}} 
	                                </div>
							{% endfor %}
	          
                        </ul><!-- .project_idea_comments -->
                    </div><!-- idea_body -->
                </li>
            {% endfor %}
            </ul><!-- .project_ideas -->
{%endblock %}
