{% extends "project_base.jinja2" %}
{% set active_page = "ideas" %}

{% block scripts %}
    {# project_base has add_idea functions #}
    {{ super() }}
    <script src="{{request.static_url('totter:static/js/jquery.autoresize.js')}}"></script>
    <script src="{{request.static_url('totter:static/js/jquery.toggle.js')}}"></script>
	<script type="text/javascript">
		function showComment(idx) {
		    $('#'+idx + '.idea').find('.project_idea_comments').show();
		}
		
		function hideComment(idx) {
		    $('#'+idx + '.idea').find('.project_idea_comments').hide();
		}
		
		
		
		function submitkey_binding(e) {
			if( e.keyCode==13 ){ // User pressed enter.
			    e.preventDefault();
                idx = $(this).attr("order");
                var prjId = "{{project.id}}";
                var cmtdata = $(this).val();
				var CommentData = JSON.stringify({'data': cmtdata, 'project_id': prjId, 'Idea_id': idx });
				$('#comments'+idx).find('.enter_to_submit.default').addClass('hidden');
				$('#comments'+idx).find('.enter_to_submit.throbber').removeClass('hidden');
				$.ajax({
					url:"{{request.application_url}}/project/{{project.id}}/idea/" + idx + "/comment",
					type: "POST",
					dataType: "json",
					data: CommentData,
					success: function(){
					    $('#comments'+idx).find('.enter_to_submit.default').removeClass('hidden');
				        $('#comments'+idx).find('.enter_to_submit.throbber').addClass('hidden');
				        
                                        
						var m_data = '<li class="last_update"> <a href="#"> <img src="{{user.profile_picture}}" width="32" height="32" /> </a>' +
										'<div class="comment_body"> <span class="comment_author"><a href="#">{{user.first_name}} </a></span><span class="comment_text">' + cmtdata + '</span></div></li>';
						sibling = $('#comments'+idx).find('.last_update');
						
						if (sibling.length > 0) {
                            sibling.removeClass('last_update');
                        }
                        $('#comments'+idx).find('ul.existing_comments').append(m_data);
						$('#comments'+idx).children('.new_comment').children('.comment_text').val('');
					}
				});
            }
		}
		
		function SortBy(sort_type){
			if (sort_type == 1) { //sort by date
				//alert("{{request.application_url}}/project/{{project.id}}/ideas?" + 'sort="date"');
				window.location = "{{request.current_route_url()}}?" + 'sort=date';
			}
			else if (sort_type == 2) { //sort by Rating
				window.location = "{{request.current_route_url()}}?" + 'sort=rating';
			}
			else if (sort_type == 3) { //sort by User
				window.location = "{{request.current_route_url()}}?" + 'sort=user';
			}
		} 
		$(document).ready(function(){
		    console.log('document.ready');
			$('.comment_input').live('keypress', submitkey_binding);
			
			$('.comment_input').autoResize({max_width : 100, min_height:'original', extraSpace: 10});
			
			// If our URL has #ideapopup on the end, open the add idea popup.
			anchor = self.document.location.hash;
			if (anchor == '#ideapopup') {
			    showAddIdea();
			}
			
			// Creates a toggle function between each of .toggle's children.
			$('.toggle').toggle('bind');
			
			// All .remember textboxes will remember their default values.
			$('.remember').default('bind');
		});
	</script>
	
	<!-- Ratings -->
	<script type="text/javascript">
		function setLiked(context, liked) {
		    if (liked) {
                context.find(".like").addClass('hidden');
                context.find(".unlike").removeClass('hidden');
            } else {
                context.find(".unlike").addClass('hidden');
                context.find(".like").removeClass('hidden');
            }                
        }
        
        function setLoved(context, loved) {
            if (loved) {
                context.find(".love").addClass('hidden');
                context.find(".unlove").removeClass('hidden');
            } else {
                context.find(".unlove").addClass('hidden');
                context.find(".love").removeClass('hidden');
            }
        }
        
        // context is some jquery selector '.foo' '#bar' that has the widget underneath it.
        // idea_id is the id of the idea being liked/disliked/loved/unloved.
        
		function unlike(selector, idea_id) {
		    send_rating($(selector), idea_id, {'like' : 0});
		}
		function unlove(selector, idea_id) {
		    send_rating($(selector), idea_id, {'love' : 0});
		}
		
		function like(selector, idea_id) {
		    send_rating($(selector), idea_id, {'like' : 1});
		}
		function love(selector, idea_id) {
		    send_rating($(selector), idea_id, {'love' : 1});
		}
		
		function send_rating(context, idea_id, rating) {
		    $.ajax({
				url:"{{request.application_url}}/project/{{project.id}}/idea/" + idea_id + "/rating",
				type: "POST",
				dataType: "json",
				data: JSON.stringify(rating),
				success: function(data) {
				    if (data.rating['liked'])
    				    setLiked(context, true);
    				else
    				    setLiked(context, false);
    				    
    				if (data.rating['loved'])
    				    setLoved(context, true);
    				else
    				    setLoved(context, false);
    				    
    			    $('#total_rating_' + idea_id).html('Total Rating: ' + data.total_rating);
				}
			});
		}
	</script>
	
	<!-- Add Idea -->
	<script type="text/javascript">
	    function showAddIdea() {
			$('.add_idea').show();
		}
		function hideAddIdea() {
		    $('.add_idea').hide();
		    $('.add_idea .remember').default();
		}
	    function addIdea_to_project() {
			var prjId = "{{project.id}}";
			var IdeaData = JSON.stringify({'data': $(".add_idea_modal textarea").val(), 'project_id': prjId });
			$.ajax({
				url:"{{request.application_url}}/project/{{project.id}}/idea",
				type: "POST",
				dataType: "json",
				data: IdeaData,
				success: onSuccess_addIdea
			});
			
			$(".add_idea .throbber").removeClass('hidden');
			$(".add_idea button").addClass('hidden');
			// Creates a toggle function between each of .toggle's children.
            $('.toggle').toggle('unbind');
            
            // All .remember textboxes will remember their default values.
            $('.remember').default('unbind');
			
			function onSuccess_addIdea(data){
			    // Successfully added our idea to the serverside.
			    var new_id = data.idea_id;
			    // Do a partial page refresh to reload the idea list:
				$('.project').load(location.href + " .project>*", function() {
				    hideAddIdea();
				    $('html,body').animate({scrollTop: $("#idea_"+new_id).offset().top},'fast');
				    $(".add_idea .throbber").addClass('hidden');
			        $(".add_idea button").removeClass('hidden');
			        
			        // Creates a toggle function between each of .toggle's children.
                    $('.toggle').toggle('bind');
                    
                    // All .remember textboxes will remember their default values.
                    $('.remember').default('bind');
			        
				});
				
				/*
				var prepare_data = '<li><div class="idea_author"><a href="#"><img src={{user.profile_picture}}?type=square"/></a></div>' +
                    '<div class="idea_body"><div class="idea_meta"><div class="username"><a href="#">{{user.first_name}}</a></div>' +
	                '<strong id="rate_value'+new_id+'">Total Rating: 0</strong><div class="like_love">' +
	                '<a href="#" id="likeidea'+new_id+'" order="1" onClick="addRating(' + new_id + ', 0, 1)">Like It</a> &bull; <a href="#" id="loveidea'+new_id+'" order="1" onClick="addRating(' + new_id + ', 0, 2)">Love It</a>' + 
	                '</div><!-- like_love --></div><!-- .idea_meta --><div class="idea_description">'+ $(".add_idea_modal textarea").val() +'</div><div class="comment_time">' +
                    '<a href="javascript:void(0)" class="comment_on_idea" onClick="showComment('+new_id+')">Comment</a>&#124;September 18th at 9:30am</div><!-- .comment_time -->' +
                    '<ul class="project_idea_comments" id="comments'+new_id+'"><li class="new_comment first_update"><input class="comment_text" type="text" value="Start Typing" order="'+new_id+'"/><br /><span class="enter_to_submit">Push Enter to Submit</span>' +
                    '</li><!-- .new_comment --><!-- Append all new comments to the ul.project_idea_comments --></ul><!-- .project_idea_comments --></div><!-- idea_body --></li>';
                $('.project_ideas').prepend(prepare_data);
                $('#comments'+new_id).children('.new_comment').children('.comment_text').bind('keypress', submitkey_binding);*/
			}
			
		}
	</script>
{% endblock %}

{% block add_idea_btn %}
<!-- Just show the overlay. -->
<button class="add_idea_button" onclick="showAddIdea()">Add Idea</button>
{% endblock %}

{% block project_body %}
            <!-- Add Idea and Modal Overlay -->
            <div class="add_idea">
                <div class="add_idea_overlay" onClick="hideAddIdea()"></div>
                <div class="add_idea_modal drop-shadow">
                    <h1>Add Idea</h1>
                    <textarea class="remember">Start typing your idea...</textarea>
                    <a href="javascript:void(0)" onClick="hideAddIdea()">Cancel</a>
                    <div class="throbber hidden">
                        <span>Posting...</span>
                        <img src="{{request.static_url('totter:static/images/throbber.gif')}}"/>
                    </div>
                    <button type="button" onClick="addIdea_to_project()">Add Idea</button>
                </div><!-- idea_idea_modal -->
            </div><!-- .add_idea -->
            
            <!-- END Add Idea and Modal Overlay -->
            
            <div class="sort_by">
                Sort by:
                <a href="{{request.current_route_url()}}?sort=date">Date</a> |
                <a href="{{request.current_route_url()}}?sort=rating">Rating</a> |
                <a href="{{request.current_route_url()}}?sort=user">User</a>
            </div><!-- .sort_by -->
            
            <ul class="project_ideas">
            {% for ideas_index in range(ideas_count) %}
                {% set idea_id = idea_data[ideas_index].idea.id %}
            	<li>
            	    <div id="{{idea_id}}" class="idea">
                        <a name="idea_{{idea_data[ideas_index].idea.id}}" id="idea_{{idea_data[ideas_index].idea.id}}"></a>
                        <div class="idea_author">
                            <a href="#">
                                <img src="{{idea_data[ideas_index].idea.author.profile_picture}}?type=square" />
                            </a>
                        </div><!-- .idea_author -->
                        <div class="idea_body">
                            <div class="idea_meta">
                            {% set liked = idea_data[ideas_index].user_rating.liked %}
                            {% set loved = idea_data[ideas_index].user_rating.loved %}
                            {% set comments = idea_data[ideas_index].idea.comments %}
                            {% set idea = idea_data[ideas_index].idea %}
                            <div class="username"><a href="#">{{idea_data[ideas_index].idea.author.first_name}}</a></div>
                            <div class="rating_system">
                                <span class="total_rating" id="total_rating_{{idea_id}}" >Total Rating: <span class="rating_value">{{idea_data[ideas_index].total_rating}}</span></span>
                                <div class="like_love" id="like_love_{{idea_id}}">
                                    <a class="like {% if liked %}hidden{% endif %}" onClick="like('#like_love_{{idea_id}}', {{idea_id}})">Like It (+1)</a>
                                    <a class="unlike {% if not liked %}hidden{% endif %}"onClick="unlike('#like_love_{{idea_id}}', {{idea_id}})">Unlike It</a>
                                    &bull;
                                    <a class="love {% if loved %}hidden{% endif %}" onClick="love('#like_love_{{idea_id}}', {{idea_id}})">Love It (+2)</a>
                                    <a class="unlove {% if not loved %}hidden{% endif %}" onClick="unlove('#like_love_{{idea_id}}', {{idea_id}})">Unlove It</a>
                                </div><!-- like_love -->
                            </div>
                            <div class="toggle toggle_comments">
                                <a class="hidden" onclick="showComment({{idea_id}})">show {{comments|length}} comments</a>
                                <a class=""       onclick="hideComment({{idea_id}})">hide comments</a>
                            </div><!-- .toggle_comments -->
                            <div class="comment_time">
                                {{idea_data[ideas_index].idea.creation_time | timefmt}}
                            </div><!-- .comment_time -->
                            
                            </div><!-- .idea_meta -->
                            <div class="idea_description">{{idea_data[ideas_index].idea.data}}</div>
                            
                             
                            <ul class="project_idea_comments" id="comments{{idea_data[ideas_index].idea.id}}">
                                <li class="existing_comments">
                                    <ul class="existing_comments">
                                    <!-- Append all new comments to the ul.project_idea_comments -->
                                    {% for comment in idea_data[ideas_index].idea.comments %}
                                        {% if loop.first %} 
                                            <li class="first_update">
                                        {% elif loop.last %}
                                            <li class="last_update">
                                        {% else %}
                                            <li>
                                        {% endif %}	
                                            <a href="#">
                                                <img src="{{comment.author.profile_picture}}?type=square" width="32" height="32" />
                                            </a>
                                            <div class="comment_body">
                                                <span class="comment_author"><a href="#">{{comment.author.first_name}}</a></span>
                                                <span class="comment_text">{{comment.data}}</span>
                                            </div>
                                            </li>
                                    {% endfor %}
                                    </ul>
                                </li>
                                <li class="new_comment first_update">
                                    <a href="#"><img src="{{user.profile_picture}}?type=square" width="32" height="32" /></a>
                                    <textarea class="comment_text comment_input remember" type="text" order="{{idea_data[ideas_index].idea.id}}">Comment</textarea><br />
                                    <span class="enter_to_submit default">Push Enter to Submit</span>
                                    <span class="enter_to_submit throbber hidden">Posting...<img src="{{request.static_url('totter:static/images/throbber.gif')}}"/></span>
                                </li><!-- .new_comment -->
                            </ul><!-- .project_idea_comments -->
                        </div><!-- idea_body -->
                    </div> <!-- .idea -->
                </li>
            {% endfor %}
            </ul><!-- .project_ideas -->
{%endblock %}
