{% extends "project_base.jinja2" %}
{% set active_page = "ideas" %}

{% block scripts %}
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
	<script type="text/javascript">
		function showComment(idx) {
			$('#comments'+idx).children('.new_comment').toggle();
		}
		
		$(document).ready(function(){
			$('input[name=comment_text]').each(function(){
				$(this).bind('keypress', function(e){
		        	if( e.keyCode==13 ){
		                idx = $(this).attr("order");
		                var prjId = "{{project.id}}";
		                var cmtdata = $(this).val();
						var CommentData = JSON.stringify({'data': cmtdata, 'project_id': prjId, 'Idea_id': idx });
						$.ajax({
							url:"{{request.application_url}}/project/{{project.id}}/idea/" + idx + "/comment",
							type: "POST",
							dataType: "json",
							data: CommentData,
							success: function(){
								idx = idx - 1
								var m_data = '<li class="first_update"> <a href="#"> <img src="{{user.profile_picture}}?type=square" width="32" height="32" /> </a>' +
												'<div class="comment_body"> <a href="#">{{user.first_name}} </a>' + cmtdata + '</div></li>';
								$('#comments'+idx).children('.new_comment').after(m_data);
								showComment(idx);	
								$('#comments'+idx).children('.new_comment').children('input[name=comment_text]').val('');
							}
						});
		            }
	        	});
			});
		});
		function addIdea() {
			$('.add_idea').toggle();
		}
		function addRating(idx, idea_id, value, type) {
			var likeobj = "#likeidea" + idx;
			var loveobj = "#loveidea" + idx;
			if (type == 1) {
				var sw_value = $(likeobj).attr("order");
				if (sw_value == "1") //now it's displayed text is "Like it"
				{ 
					$(likeobj).attr("order", "2");
					$(likeobj).text("Unlike it");
					$(loveobj).attr("order", "1");
					$(loveobj).text("Love it");
					value = value + 1
					ratingData = JSON.stringify({'like': 1, 'love': 0});
				}
				else if (sw_value == "2" ) //now it's displayed text is "Unlike it"
				{
					$(likeobj).attr("order", "1");
					$(likeobj).text("Like it");
					$(loveobj).attr("order", "1");
					$(loveobj).text("Love it");
					value = value - 1
					ratingData = JSON.stringify({'like': 0, 'love': 0});
				}
			}
			else if (type == 2){
				var sw_value = $(loveobj).attr("order");
				if (sw_value == "1") //now it's displayed text is "Love it"
				{ 
					$(loveobj).attr("order", "2");
					$(loveobj).text("Unlove it");
					$(likeobj).attr("order", "1");
					$(likeobj).text("Like it");
					value = value + 2
					ratingData = JSON.stringify({'like': 0, 'love': 1});
				}
				else if (sw_value == "2" ) //now it's displayed text is "Unlove it"
				{
					$(loveobj).attr("order", "1");
					$(loveobj).text("Love it");
					$(likeobj).attr("order", "1");
					$(likeobj).text("Like it");
					value = value - 2
					ratingData = JSON.stringify({'like': 0, 'love': 0});
				}
			}
			
			outText = 'Total Rating: ' + value;
			idText = "rate_value" + idx;
			$('#'+idText).html(outText);
			$.ajax({
				url:"{{request.application_url}}/project/{{project.id}}/idea/" + idea_id + "/rating",
				type: "POST",
				dataType: "json",
				data: ratingData,
				success: function(){
					//alert("ajax success");
				}
			});
		}
		
		function addIdea_to_project() {
			var prjId = "{{project.id}}";
			var IdeaData = JSON.stringify({'data': $(".add_idea_modal textarea").val(), 'project_id': prjId });
			$.ajax({
				url:"{{request.application_url}}/project/{{project.id}}/idea",
				type: "POST",
				dataType: "json",
				data: IdeaData,
				success: onSuccess_addIdea
			});
			
			function onSuccess_addIdea(data){
				var last_idx = data.ideas_count;
				var new_id = data.idea_id;
				var prepare_data = '<li><div class="idea_author"><a href="#"><img src={{user.profile_picture}}?type=square"/></a></div>' +
                    '<div class="idea_body"><div class="idea_meta"><div class="username"><a href="#">{{user.first_name}}</a></div>' +
	                '<strong id="rate_value'+last_idx+'">Total Rating: 0</strong><div class="like_love">' +
	                '<a href="#" name="likeidea" class="like_love" onClick="addRating(' + last_idx + ',' + new_id + ', 0, 1)">Like It</a> &bull; <a href="#" name="loveidea" class="like_love" onClick="addRating(' + last_idx + ',' + new_id + ', 0, 2)">Love It</a>' + 
	                '</div><!-- like_love --></div><!-- .idea_meta --><div class="idea_description">'+ $(".add_idea_modal textarea").val() +'</div><div class="comment_time">' +
                    '<a href="javascript:void(0)" class="comment_on_idea" onClick="showComment('+new_id+')">Comment</a>&#124;September 18th at 9:30am</div><!-- .comment_time -->' +
                    '<ul class="project_idea_comments" id="comments'+new_id+'"><li class="new_comment first_update"><input name="comment_text" type="text" value="Start Typing" order="'+new_id+'"/><br /><span class="enter_to_submit">Push Enter to Submit</span>' +
                    '</li><!-- .new_comment --><!-- Append all new comments to the ul.project_idea_comments --></ul><!-- .project_idea_comments --></div><!-- idea_body --></li>';
                $('.project_ideas').prepend(prepare_data);   
				alert(new_id);
				alert('test'+$('input[order=5]').val());
                $('input[order=new_id]').bind('keypress', function(e){
		        	if( 1 ){
		                idx = $(this).attr("order");
		                alert(idx);
		                alert(new_id);
		                var prjId = "{{project.id}}";
		                var cmtdata = $(this).val();
						var CommentData = JSON.stringify({'data': cmtdata, 'project_id': prjId, 'Idea_id': idx });
						$.ajax({
							url:"{{request.application_url}}/project/{{project.id}}/idea/" + idx + "/comment",
							type: "POST",
							dataType: "json",
							data: CommentData,
							success: function(){
								idx = idx - 1
								var m_data = '<li class="first_update"> <a href="#"> <img src="{{user.profile_picture}}?type=square" width="32" height="32" /> </a>' +
												'<div class="comment_body"> <a href="#">{{user.first_name}} </a>' + cmtdata + '</div></li>';
								$('#comments'+idx).children('.new_comment').after(m_data);
								showComment(idx);	
								$('#comments'+idx).children('.new_comment').children('input[name=comment_text]').val('');
							}
						});
		            }
	        	});
			}
			addIdea();
		}
	</script>
{% endblock %}

{% block project_body %}
            <div class="sort_by">
                Sort by:<br />
                <button type="button">Date</button>
                <button type="button">Rating</button>
                <button type="button">User</button>
            </div><!-- .sort_by -->
            
            <ul class="project_ideas">
            {% for ideas_index in range(ideas_count) %}
            	<li>
                	<div class="idea_author">
                    	<a href="#">
                            <img src={{idea_data[ideas_index].idea.author.profile_picture}}?type=square" />
                        </a>
                    </div><!-- .idea_author -->
                    <div class="idea_body">
                        <div class="idea_meta">
                        <div class="username"><a href="#">{{idea_data[ideas_index].idea.author.first_name}}</a></div>
	                    	<strong id="rate_value{{ideas_index}}" >Total Rating: {{idea_data[ideas_index].total_rating}}</strong>
	                        <div class="like_love">
	                        {% if idea_data[ideas_index].user_rating.liked == 1 %}
	                        	<a href="#" id="likeidea{{ideas_index}}" order="2" onClick="addRating({{ideas_index}}, {{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 1)">Unlike It</a>
	                        {% else %}
	                        	 <a href="#" id="likeidea{{ideas_index}}" order="1" onClick="addRating({{ideas_index}}, {{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 1)">Like It</a>
	               			{% endif %}         	 
	                            &bull; 
	                        {% if idea_data[ideas_index].user_rating.loved == 1 %}
	                            <a href="#" id="loveidea{{ideas_index}}" order="2" onClick="addRating({{ideas_index}}, {{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 2)">Unlove It</a>
	                        {% else %}
	                        	<a href="#" id="loveidea{{ideas_index}}" order="1" onClick="addRating({{ideas_index}}, {{idea_data[ideas_index].idea.id}}, {{idea_data[ideas_index].total_rating}}, 2)">Love It</a>
	                       	{% endif %} 
	                        </div><!-- like_love -->
                        </div><!-- .idea_meta -->
                    	<div class="idea_description">{{idea_data[ideas_index].idea.data}}</div>
                        <div class="comment_time">
                            <a href="javascript:void(0)" class="comment_on_idea" onClick="showComment({{ideas_index}})">Comment</a> 
                            &#124; 
                            September 18th at 9:30am
                        </div><!-- .comment_time -->
                         
                        <ul class="project_idea_comments" id="comments{{ideas_index}}">
                            <li class="new_comment first_update">
                            	<input name="comment_text" type="text" value="Start Typing" order = "{{idea_data[ideas_index].idea.id}}"/><br />
                                <span class="enter_to_submit">Push Enter to Submit</span>
                            </li><!-- .new_comment -->
                             
                            <!-- Append all new comments to the ul.project_idea_comments -->
                            
                            {% for comment in idea_data[ideas_index].idea.comments %}
	                            {% if loop.first %} 
	                            	<li class="first_update">
	                            {% elif loop.last %}
	                            	<li class="last_update">
	                            {% else %}
	                            	<li>
	                            {% endif %}	
	                            	<a href="#">
	                                	<img src="{{comment.author.profile_picture}}?type=square" width="32" height="32" />
	                                </a>
	                                <div class="comment_body">
	                                    <a href="#">{{comment.author.first_name}}</a>
	                                    {{comment.data}} 
	                                </div>
							{% endfor %}
	          
                        </ul><!-- .project_idea_comments -->
                    </div><!-- idea_body -->
                </li>
            {% endfor %}
            </ul><!-- .project_ideas -->
{%endblock %}
