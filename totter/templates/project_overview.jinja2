{% extends "project_base.jinja2" %}
{% set active_page = "overview" %}

{% block scripts %}
{{ super() }}
<script src="{{request.static_url('totter:static/js/jquery.tmpl.js')}}"></script>
<script src="{{request.static_url('totter:static/js/jquery.autoresize.js')}}"></script>
<script type="text/javascript">
function addUpdate() {
    $('.add_update').toggle();
}
function addUpdate_to_project() {
    var prjId = "{{project.id}}";
    var IdeaData = JSON.stringify({'data': $(".add_update_modal textarea").val(), 'project_id': prjId });
    $.ajax({
        url:"{{request.model_url(context, 'updates')}}",
        type: "POST",
        dataType: "json",
        data: IdeaData,
        success: onSuccess_addUpdate
    });
    
    function onSuccess_addUpdate(data){
        var new_id = data.idea_id;
        var when = data.when;
        var text = data.data;
        var update_data = {'when' : when, 'data' : text};
        var prepare_data = $('#updateTemplate').tmpl(update_data);
        
        var after = $('.updates_header');
        $('.first_update').removeClass('first_update');
        after.after(prepare_data);
    }
    addUpdate();
}
</script>
{# Turn Jinja2 off, this is jquery.tmpl's territory. #}
{% raw %}
<script id="updateTemplate" type="text/x-jquery-tmpl">
<li class="first_update">
    <span class="project_update_date">${when}</span><br />
        ${data}
</li>
</script>
{% endraw %}

{% endblock %}
{% block project_body %}
<div class="add_idea add_update">
    <div class="add_idea_overlay add_update_overlay" onClick="addUpdate()"></div>
    <div class="add_idea_modal add_update_modal drop-shadow">
        <h1>Add Update</h1>
        <textarea>Start typing your update...</textarea>
        <a href="javascript:void(0)" onClick="addUpdate()">Cancel</a>
        <button type="button" onClick="addUpdate_to_project()">Add Update</button>
    </div><!-- idea_idea_modal -->
</div><!-- .add_idea -->
            

<div class="project_description">
    <h2>Description</h2>
    
    <p id="description" class="{%if editable %}edit_area{% endif %}">{{project.description}}</p>
</div><!-- .project_description -->

<ul class="project_updates">
    <div class="updates_header">
        <h2>Updates</h2>
        <button type="button" onClick="addUpdate()" class="add_update_button">Add Update</button>
    </div> <!-- .updates_header -->
    {% for update in updates %}
    <li {% if loop.first %}class="first_update"{% endif %}{% if loop.last %}class="last_update"{% endif %}>
        <span class="project_update_date">{{update.when | timefmt}}</span><br />
            {{update.data}}
    </li>
    {% endfor %}
</ul><!-- .project_updates -->

{% endblock %}